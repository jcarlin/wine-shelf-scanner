name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: false
        default: 'production'

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  REGION: us-central1
  SERVICE_NAME: wine-scanner-api
  REPO_NAME: wine-scanner

jobs:
  test:
    uses: ./.github/workflows/test.yml

  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: test
    if: false  # Temporarily disabled - re-enable after setting up ANTHROPIC_API_KEY in Secret Manager
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build image
        working-directory: backend
        run: |
          docker build \
            -t "${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}" \
            -t "${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:latest" \
            .

      - name: Push image
        run: |
          docker push "${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          docker push "${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:latest"

      - name: Deploy to Cloud Run
        run: |
          sed "s|IMAGE_PLACEHOLDER|${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}|g" \
            backend/deploy/service.yaml > /tmp/service.yaml
          gcloud run services replace /tmp/service.yaml \
            --region ${{ env.REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }}

      - name: Set public access
        run: |
          gcloud run services add-iam-policy-binding ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --member="allUsers" \
            --role="roles/run.invoker" \
            --quiet

      - name: Verify health
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region ${{ env.REGION }} \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --format="value(status.url)")
          echo "Deployed to: $URL"
          curl -sf "$URL/health" || (sleep 10 && curl -sf "$URL/health")
