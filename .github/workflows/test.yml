name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_call:

concurrency:
  group: test-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/requirements-dev.txt

      - name: Install dependencies
        run: pip install -r requirements-dev.txt

      - name: Install Playwright browsers
        run: playwright install chromium

      - name: Verify Alembic migrations (fresh DB)
        run: |
          rm -f app/data/wines.db
          alembic upgrade head
          python -c "
          import sqlite3
          conn = sqlite3.connect('app/data/wines.db')
          tables = [r[0] for r in conn.execute(\"SELECT name FROM sqlite_master WHERE type='table'\").fetchall()]
          expected = ['wines', 'wine_aliases', 'wine_sources', 'wine_fts', 'llm_ratings_cache', 'corrections', 'wine_reviews']
          missing = [t for t in expected if t not in tables]
          assert not missing, f'Missing tables after migration: {missing}'
          print(f'Migration OK: {len(tables)} tables created')
          conn.close()
          "
          rm -f app/data/wines.db

      - name: Run pytest
        run: pytest tests/ -v --tb=short -k "not (test_scan_returns_valid_response or test_accepts_jpeg or test_accepts_png)"
        env:
          USE_MOCKS: "true"
          USE_SQLITE: "true"

  backend-docker:
    name: Backend Docker Build & Startup
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        working-directory: backend
        run: docker build -t wine-scanner-api:test .

      - name: Verify startup script, migrations, and health
        run: |
          # Run the container exactly as Cloud Run does:
          #   CMD ["python", "scripts/startup.py"]
          # which does: GCS download (skipped, no bucket) -> Alembic migrations -> uvicorn
          docker run -d --name wine-test \
            -p 8080:8080 \
            -e USE_MOCKS=true \
            -e USE_SQLITE=true \
            wine-scanner-api:test

          # Wait for startup.py -> alembic -> uvicorn to be ready (up to 30s)
          for i in $(seq 1 15); do
            if curl -sf http://localhost:8080/health; then
              echo ""
              echo "Health check passed"
              break
            fi
            sleep 2
          done

          # Fail fast if health never responded
          if ! curl -sf http://localhost:8080/health > /dev/null; then
            echo "Health check failed — container logs:"
            docker logs wine-test
            docker stop wine-test
            exit 1
          fi

          # Verify startup.py ran Alembic migrations successfully
          LOGS=$(docker logs wine-test 2>&1)
          if echo "$LOGS" | grep -q "Migration failed"; then
            echo "Alembic migration failed — container logs:"
            echo "$LOGS"
            docker stop wine-test
            exit 1
          fi
          echo "Alembic migrations: OK"

          # Verify /scan endpoint loads and can serve a request
          # Use mock_scenario=full_shelf to bypass Vision API (no GCP creds in CI)
          # This exercises: route loading, image handling, Pydantic serialization, mock fixtures
          printf '\xff\xd8\xff\xe0' > /tmp/tiny.jpg
          SCAN_STATUS=$(curl -s -o /tmp/scan_response.json -w "%{http_code}" \
            -X POST "http://localhost:8080/scan?mock_scenario=full_shelf" \
            -F "image=@/tmp/tiny.jpg;type=image/jpeg;filename=test.jpg" \
            2>/dev/null || echo "000")
          if [ "$SCAN_STATUS" != "200" ]; then
            echo "Scan endpoint returned HTTP $SCAN_STATUS (expected 200) — container logs:"
            docker logs wine-test
            docker stop wine-test
            exit 1
          fi
          echo "Scan endpoint: HTTP 200 OK"

          docker stop wine-test

  nextjs-tests:
    name: Next.js Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: nextjs

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: nextjs/package-lock.json

      - run: npm ci
      - run: npm run type-check
      - run: npm test
      - run: npm run lint
      - run: npm run build
        env:
          NEXT_PUBLIC_API_BASE_URL: "http://localhost:8000"

  i18n-validation:
    name: i18n Key Validation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Validate locale files have matching keys
        run: node scripts/validate-i18n.js
